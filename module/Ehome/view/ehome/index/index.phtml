<?php 
use \Zend\Debug\Debug;

$showFloorplan = false;
if ($ehomeConfig['floorplan'] != ""){
	$showFloorplan = true;
}
$floorplanHeader = $ehomeConfig['residentUser'] . ", " . $ehomeConfig['residentStreet'] . ", " .  $ehomeConfig['residentCity'];

// process event table to messages
$logMessages = array();
$healthMessages = array();
$warningMessages = array();
foreach($events as $event){
	if ($event->getType() == "message"){
		$logMessages[] = $event;
	}
	if ($event->getType() == "message" && $event->getName() == 'Warnung'){
		$warningMessages[] = $event;
	}
	if ($event->getType() == "health"){
		$healthMessages[] = $event;
	}
}
?>
<!-- DEBUGGING AREA -->
<div class='row'>
	<div class='span12'>
		<h2>Debugging Area</h2>
		<p>
			<a class="btn"
				href="<?php echo $this->url('home', array('action' => 'temp', 'id' => '0')); ?>">TempAction</a>
		</p>
	</div>
</div>
<hr>
<!-- // DEBUGGING AREA -->
<!-- Startseite -->
<div class="row">
	<div class="span12">
		<p style="text-align: center;">
			<img src='<?php echo $this->basePath(); ?>/img/ehome-center-logo.png'
				alt="Bild Header E|Home-Center" />
		</p>
	</div>
</div>
<div class="hero-unit">
	<h1><?php echo sprintf("Willkommen!", '<span class="zf-green">', '</span>') ?></h1>
	<p><?php echo $floorplanHeader; ?></p>
	<p <?php if(!$showFloorplan){ echo 'style="display:none"'; } ?>>
		[<a class="show_hide" href="#" rel="#container">+/-</a>]
	</p>
	<div id="container"
		<?php if(!$showFloorplan){ echo 'style="display:none"'; } ?>>
		<div id="background">
			<img alt="Floorplan"
				src='<?php echo $this->basePath();?>/img/floorplan.jpg'>
		</div>
	</div>
	<!-- // div container -->
</div>
<!-- // hero-unit -->
<hr>
<div class='row'>
	<div class='span4'>
		<h2>Cockpit</h2>
		<div style='float: left; padding-right: 16px;'><?php 
			//if (!$this->localNetwork){ // TODO if relevant detect if there is a connection automatically
				echo $this->gravatar($this->zfcUserIdentity()->getEmail());
			//} 
		?>
    </div>
		<p> Angemeldet als <?php echo $useremail; ?>
    	</p>
		<p><a class='btn' href="<?php echo $this->url('home', array('action' => 'logout')); ?>">Ausloggen</a>
		</p>
	</div>
	<div class='span5'>
		<h2>Hinweise</h2>
<?php
echo "<ul>";	 
$openWarningMessagesCounter = 0;
foreach($warningMessages as $warningMessage){
	if ($warningMessage->getDone() == 1){
		continue;
	}
	echo "<li>";
    //echo $warningMessage->getId() . "; ";
    echo "<span style='color: red;'>" . $warningMessage->getName() . "</span>: ";
    echo $warningMessage->getValue() . "; ";
        //echo $warningMessage->getStart() . "; ";
        //echo $warningMessage->getEnd() . "; ";
        //if ($warningMessage->getDone() == 1){
		//	echo "<span style='color: green;'>OK</span>; ";
		//} else {
		//	echo "<span style='color: red;'>ACHTUNG</span>; ";
		//}
        //echo "<a href='' title=''>edit</a>" . "; ";
        //echo "<a href='' title=''>delete</a>" . "; ";
    echo "<a class='btn' href='" . $this->url('home', array('action' => 'togglemessage' , 'id' => $warningMessage->getId())) . "' title='Nachricht als zur Kenntnis genommen markieren und verstecken.'>x</a>";
	echo "</li>";
	$openWarningMessagesCounter++;
}
if ($openWarningMessagesCounter == 0){
	echo "<li>";
	echo "Alle Warnungen wurden gelesen und als erledigt markiert!";
	echo "</li>";
}
echo "</ul>"
?>
	</div>
	<div class='span3'>
		<h2>Hilfe</h2>
		<p>
			Wir helfen Ihnen gerne:<br> support@example.org und 01234-12345
		</p>
	</div>
</div>
<hr>
<div class='row'>
	<div class='span12'>
		<h2>Räume</h2>
		<p>
			[<a class="show_hide" href="#" rel="#rooms">+/-</a>]
		</p>
		<div id="rooms">
			<table border="1px">
				<tr>
					<th>Name</th>
					<th>Luftfeuchtigkeit</th>
					<th>Temperatur</th>
					<th>Schalter</th>
					<th>Aktion</th>
				</tr>
<?php 
// show rooms table on website
foreach($this->rooms as $room ){
	$showEnterRoom = false;
	echo "<tr>";
	echo "<td>" . $room->getName() . "</td>";
	echo "<td style='text-align: right;'>" . $room->getHumidity () . "</td>";
	echo "<td style='text-align: right;'>" . $room->getTemperature () . "</td>";
	if ($room->getSwitch() == 100){
		$formActionId = 0;
		$isRelevant = false;
		foreach ($configActions as $configAction ) {
			$actionId = $configAction['id'];
			$actionRoomId = $configAction ['roomId'];
			if ($room->getId() == $actionRoomId && $configAction ['type'] == "switch" && $configAction['value'] == "turnOff") {
				$showEnterRoom = true;
				$formActionId = $actionId;
				$isRelevant = true;
				echo "<td style='text-align: right;'>";
				echo "<span style='color:orange;'>AN </span> ";
				$roomId = $room->getId();
				$configActions = $ehomeConfig['action'];
				echo "<a href='" . $this->url('home', array (
					'action' => 'do',
					'id' => $formActionId
				) ) . "' title='Bearbeiten des Eintrags' class='btn btn-success'><></a>";
				echo "</td>";
			}
		}
		if (! $isRelevant) {
			echo "<td style='text-align: right;'>";
			echo "&nbsp;";
			//echo "<a href='" . $this->url ( 'home', array ('action' => 'do', 'id' => 0 ) ) . "' title='Bearbeiten des Eintrags' class='btn btn-success'><></a>";
			echo "</td>";
		}
	} else if ($room->getSwitch() == 0) { // zustand ist 0 also aus, brauchen gruenen knopf mit passender action
		$formActionId = 0;
		$configActions = $ehomeConfig['action'];
		$isRelevant = false;
		foreach ($configActions as $configAction ) {
			$actionId = $configAction ['id'];
			$actionRoomId = $configAction['roomId'];
			if ($room->getId() == $actionRoomId && $configAction ['type'] == "switch" && $configAction['value'] == "turnOn") {
				$showEnterRoom = true;
				$formActionId = $actionId;
				$isRelevant = true;
				echo "<td style='text-align: right;'>";
				echo "<span style='color:green;'>AUS</span> ";
				echo "<a href='" . $this->url ('home', array (
						'action' => 'do',
						'id' => $formActionId
				) ) . "' title='Bearbeiten des Eintrags' class='btn btn-success'><></a>";
				echo "</td>";
			}
		}
		if (! $isRelevant){
			echo "<td style='text-align: right;'>";
			echo "&nbsp;";
			echo "</td>";
		}
	} else {
		// TODO detect non relevant status by inspecting configuration
		// TODO think about throwing an exception
	}
	if ($showEnterRoom){
		echo "<td><a href='" . $this->url('home', array ('action' => 'editroom','id' => $room->getId())) . "' title='Bearbeiten des Eintrags' class='btn btn-success'>Eintreten &raquo;</a>" . "</td>";
	} else {
		echo "<td>&nbsp;</td>";
	}
	echo "</tr>";
}
echo "</table>";
?>
		</div>
				</div>
				</div>
				<hr>
				<div class="row">
					<div class="span12">
						<h2>Gesundheitsdaten</h2>
						<p>
							[<a class="show_hide" href="#" rel="#health">+/-</a>]
						</p>
						<div id='health'>
							<!-- Sub containers -->
							<div class='row'>
								<div class='span6'>
                <?php 
echo "<table border='1px'>";
echo "<tr>";
echo "<th>Datum</th>";
echo "<th>Uhrzeit</th>";
echo "<th>Meldung</th>";
echo "<th>Wert</th>";
echo "<th>Bemerkung</th>";
echo "</tr>";
$healthMessageCounter = 0;
$healthMessagesReversed = array_reverse($healthMessages);
foreach($healthMessagesReversed as $healthMessage){
		if ($healthMessageCounter > 5){
			continue;
		}
		echo "<tr>";
		echo "<td>";
		$date = new DateTime($healthMessage->getStart());
        echo $date->format('d.m.Y');
        echo "</td>";
        echo "<td>";
        $date = new DateTime($healthMessage->getStart());
        echo $date->format('h:m');
        echo "</td>";
		echo "<td>";
		echo $healthMessage->getName();
		echo "</td>";
		echo "<td>";
		echo $healthMessage->getValue();
		echo "</td>";
		echo "<td>";
		if ($healthMessage->getDone() == 1){
			echo "<span style='color: green;'>OK</span>";
		} else {
			echo "<span style='color: red;'>ACHTUNG</span>";
		}
		echo "</td>";
		echo "</tr>";
		$healthMessageCounter++;
}
echo "</table>"
?>
                
                </div>
								<div class='span6'>
									<!-- RGraph Lib // start -->
									<canvas id="weightGraph" width="500" height="150">[No canvas support]</canvas>
									<canvas id="pulseGraph" width="500" height="150">[No canvas support]</canvas>
									<script>
        window.onload = function()
        {
            var weightLine = new RGraph.Line('weightGraph', [82.4,82.8,82.6,82.2,82.0,79.3,79.6,79.1,78.2,78.9,77.3])
			.Set('title','Gewichtsentwicklung 2013')
            .Set('spline', true)
            .Set('numxticks', 0)
            .Set('numyticks', 0)
            .Set('hmargin', 10)
            .Set('background.grid.autofit.numvlines', 11)
            .Set('colors', ['orange'])
            .Set('linewidth', 5)
            .Set('gutter.left', 40)
            .Set('gutter.right', 15)
            .Set('labels',['Jan','Feb','Mär','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov'])
            .Set('shadow',true)
            .Set('shadow.color','#aaa')
            .Set('shadow.blur',5)
            .Draw();
            
            var pulseGraph = new RGraph.Line('pulseGraph', [65,68,66,61,68,72,66,63,66,68,69])
			.Set('title','Pulsentwicklung 2013')
            .Set('spline', true)
            .Set('numxticks', 0)
            .Set('numyticks', 0)
            .Set('hmargin', 10)
            .Set('background.grid.autofit.numvlines', 11)
            .Set('colors', ['orange'])
            .Set('linewidth', 5)
            .Set('gutter.left', 40)
            .Set('gutter.right', 15)
            .Set('labels',['Jan','Feb','Mär','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov'])
            .Set('shadow',true)
            .Set('shadow.color','#aaa')
            .Set('shadow.blur',5)
            .Draw();
        };
    	</script>
									<!-- RGraph Lib // end -->
								</div>
							</div>
						</div>
					</div>
				</div>
				<hr>
				<div class="row">
					<div class="span12">
						<h2>Systemnachrichten</h2>
						<p>
							[<a class="show_hide" href="#" rel="#messages">+/-</a>]
						</p>
						<div id='messages'>
<?php 
$logMessagesReversed = array_reverse($logMessages);
echo "<ul>";
$logMessageCounter = 0;
foreach($logMessagesReversed as $logMessage){
		if($logMessageCounter > 8){
			continue;
		}
        echo "<li>";
        $date = new DateTime($logMessage->getStart());
        echo $date->format('d.m.Y');
        echo ", ";
        echo $date->format('h:m');
        echo "Uhr, ";
        echo $logMessage->getValue(); 
        echo "</li>";
        $logMessageCounter++;
}
echo "</ul>";
?>
		</div>
					</div>
				</div>
				<!-- 
                 <p>
                        <a class="btn" href="<?php // echo $this->url('clearlog'); ?>">Systemnachrichten l�schen</a>
                </p>

        </div>
</div>
-->
				<!-- 
<div class="row">
        <div class="span12">
                <h2>Haussystem</h2>
                <p>
                        Energiefuellstand Solaranlage; Anzahl der Benutzer; Datenzugriffe extern;
                </p>
                <p>
                        <a class="btn" href="">Betreten</a>
                </p>
        </div>
</div>
-->
				<!-- 
<div class="row">
        <div class="span12">
                <h2>Gemeinschaftsmodul</h2>
                <p>Organisation der Gartenbepflanzung</p>
                <p>
                        <a class="btn" href="">Betreten</a>
                </p>
        </div>
</div>
-->